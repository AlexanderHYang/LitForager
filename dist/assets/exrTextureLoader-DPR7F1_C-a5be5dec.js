import{t as pe,c as Y,f as ye}from"./index-c34e7bd4.js";const oe=4,Z=4,ae=1,R=2,de=8,D=65536,K=D>>3,ve=16,P=14,z=(1<<ve)+1,J=1<<P,Q=J-1,X=59,ie=63,be=2+ie-X;var C;(function(e){e[e.NO_COMPRESSION=0]="NO_COMPRESSION",e[e.RLE_COMPRESSION=1]="RLE_COMPRESSION",e[e.ZIPS_COMPRESSION=2]="ZIPS_COMPRESSION",e[e.ZIP_COMPRESSION=3]="ZIP_COMPRESSION",e[e.PIZ_COMPRESSION=4]="PIZ_COMPRESSION",e[e.PXR24_COMPRESSION=5]="PXR24_COMPRESSION"})(C||(C={}));var G;(function(e){e[e.INCREASING_Y=0]="INCREASING_Y",e[e.DECREASING_Y=1]="DECREASING_Y"})(G||(G={}));const F=Se();function Se(){const e=new ArrayBuffer(4),t=new Float32Array(e),r=new Uint32Array(e),o=new Uint32Array(512),n=new Uint32Array(512);for(let a=0;a<256;++a){const i=a-127;i<-27?(o[a]=0,o[a|256]=32768,n[a]=24,n[a|256]=24):i<-14?(o[a]=1024>>-i-14,o[a|256]=1024>>-i-14|32768,n[a]=-i-1,n[a|256]=-i-1):i<=15?(o[a]=i+15<<10,o[a|256]=i+15<<10|32768,n[a]=13,n[a|256]=13):i<128?(o[a]=31744,o[a|256]=64512,n[a]=24,n[a|256]=24):(o[a]=31744,o[a|256]=64512,n[a]=13,n[a|256]=13)}const l=new Uint32Array(2048),s=new Uint32Array(64),c=new Uint32Array(64);for(let a=1;a<1024;++a){let i=a<<13,u=0;for(;!(i&8388608);)i<<=1,u-=8388608;i&=-8388609,u+=947912704,l[a]=i|u}for(let a=1024;a<2048;++a)l[a]=939524096+(a-1024<<13);for(let a=1;a<31;++a)s[a]=a<<23;s[31]=1199570944,s[32]=2147483648;for(let a=33;a<63;++a)s[a]=2147483648+(a-32<<23);s[63]=3347054592;for(let a=1;a<64;++a)a!==32&&(c[a]=1024);return{floatView:t,uint32View:r,baseTable:o,shiftTable:n,mantissaTable:l,exponentTable:s,offsetTable:c}}function $(e,t){const r=new Uint8Array(e);let o=0;for(;r[t.value+o]!=0;)o+=1;const n=new TextDecoder().decode(r.slice(t.value,t.value+o));return t.value=t.value+o+1,n}function I(e,t){const r=e.getInt32(t.value,!0);return t.value+=oe,r}function m(e,t){const r=e.getUint32(t.value,!0);return t.value+=oe,r}function B(e,t){const r=e.getUint8(t.value);return t.value+=ae,r}function W(e,t){const r=e.getUint16(t.value,!0);return t.value+=R,r}function se(e,t){const r=e[t.value];return t.value+=ae,r}function Ee(e,t){let r;return"getBigInt64"in DataView.prototype?r=Number(e.getBigInt64(t.value,!0)):r=e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=de,r}function S(e,t){const r=e.getFloat32(t.value,!0);return t.value+=Z,r}function ge(e,t){return Ae(W(e,t))}function Ae(e){const t=(e&31744)>>10,r=e&1023;return(e>>15?-1:1)*(t?t===31?r?NaN:1/0:Math.pow(2,t-15)*(1+r/1024):6103515625e-14*(r/1024))}function Oe(e){if(Math.abs(e)>65504)throw new Error("Value out of range.Consider using float instead of half-float.");e=ye(e,-65504,65504),F.floatView[0]=e;const t=F.uint32View[0],r=t>>23&511;return F.baseTable[r]+((t&8388607)>>F.shiftTable[r])}function Ie(e,t){return Oe(S(e,t))}function Ce(e,t,r){const o=new TextDecoder().decode(new Uint8Array(e).slice(t.value,t.value+r));return t.value=t.value+r,o}function Ue(e,t){const r=I(e,t),o=m(e,t);return[r,o]}function me(e,t){const r=m(e,t),o=m(e,t);return[r,o]}function Me(e,t){const r=S(e,t),o=S(e,t);return[r,o]}function Pe(e,t){const r=S(e,t),o=S(e,t),n=S(e,t);return[r,o,n]}function xe(e,t,r){const o=t.value,n=[];for(;t.value<o+r-1;){const l=$(e.buffer,t),s=I(e,t),c=B(e,t);t.value+=3;const a=I(e,t),i=I(e,t);n.push({name:l,pixelType:s,pLinear:c,xSampling:a,ySampling:i})}return t.value+=1,n}function Ne(e,t){const r=S(e,t),o=S(e,t),n=S(e,t),l=S(e,t),s=S(e,t),c=S(e,t),a=S(e,t),i=S(e,t);return{redX:r,redY:o,greenX:n,greenY:l,blueX:s,blueY:c,whiteX:a,whiteY:i}}function Re(e,t){return B(e,t)}function ke(e,t){const r=I(e,t),o=I(e,t),n=I(e,t),l=I(e,t);return{xMin:r,yMin:o,xMax:n,yMax:l}}function Te(e,t){const r=B(e,t);return G[r]}function ze(e,t,r,o){switch(r){case"string":case"stringvector":case"iccProfile":return Ce(e.buffer,t,o);case"chlist":return xe(e,t,o);case"chromaticities":return Ne(e,t);case"compression":return Re(e,t);case"box2i":return ke(e,t);case"lineOrder":return Te(e,t);case"float":return S(e,t);case"v2f":return Me(e,t);case"v3f":return Pe(e,t);case"int":return I(e,t);case"rational":return Ue(e,t);case"timecode":return me(e,t);case"preview":return t.value+=o,"skipped";default:t.value+=o;return}}function ce(e){for(let t=1;t<e.length;t++){const r=e[t-1]+e[t]-128;e[t]=r}}function le(e,t){let r=0,o=Math.floor((e.length+1)/2),n=0;const l=e.length-1;for(;!(n>l||(t[n++]=e[r++],n>l));)t[n++]=e[o++]}const _e=20000630;function Le(e,t){if(e.getUint32(0,!0)!=_e)throw new Error("Incorrect OpenEXR format");const r=e.getUint8(4),o=e.getUint8(5),n={singleTile:!!(o&2),longName:!!(o&4),deepFormat:!!(o&8),multiPart:!!(o&16)};t.value=8;const l={};let s=!0;for(;s;){const c=$(e.buffer,t);if(!c)s=!1;else{const a=$(e.buffer,t),i=m(e,t),u=ze(e,t,a,i);u===void 0?pe.Warn(`Unknown header attribute type ${a}'.`):l[c]=u}}if(o&-5)throw new Error("Unsupported file format");return{version:r,spec:n,...l}}const ue=16,Fe=1<<ue-1,ee=(1<<ue)-1;function De(e,t){let r=0;for(let n=0;n<D;++n)(n==0||e[n>>3]&1<<(n&7))&&(t[r++]=n);const o=r-1;for(;r<D;)t[r++]=0;return o}function We(e){for(let t=0;t<J;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}function te(e,t,r,o,n){for(;r<e;)t=t<<8|se(o,n),r+=8;return r-=e,{l:t>>r&(1<<e)-1,c:t,lc:r}}function j(e,t,r,o){return e=e<<8|se(r,o),t+=8,{c:e,lc:t}}function H(e,t,r,o,n,l,s,c,a){if(e==t){if(o<8){const w=j(r,o,n,l);r=w.c,o=w.lc}o-=8;let i=r>>o;if(i=new Uint8Array([i])[0],c.value+i>a)return null;const u=s[c.value-1];for(;i-- >0;)s[c.value++]=u}else if(c.value<a)s[c.value++]=e;else return null;return{c:r,lc:o}}const T=new Array(59);function Be(e){for(let r=0;r<=58;++r)T[r]=0;for(let r=0;r<z;++r)T[e[r]]+=1;let t=0;for(let r=58;r>0;--r){const o=t+T[r]>>1;T[r]=t,t=o}for(let r=0;r<z;++r){const o=e[r];o>0&&(e[r]=o|T[o]++<<6)}}function Ve(e,t,r,o,n,l){const s=t;let c=0,a=0;for(;o<=n;o++){if(s.value-t.value>r)return;let i=te(6,c,a,e,s);const u=i.l;if(c=i.c,a=i.lc,l[o]=u,u==ie){if(s.value-t.value>r)throw new Error("Error in HufUnpackEncTable");i=te(8,c,a,e,s);let w=i.l+be;if(c=i.c,a=i.lc,o+w>n+1)throw new Error("Error in HufUnpackEncTable");for(;w--;)l[o++]=0;o--}else if(u>=X){let w=u-X+2;if(o+w>n+1)throw new Error("Error in HufUnpackEncTable");for(;w--;)l[o++]=0;o--}}Be(l)}function fe(e){return e&63}function we(e){return e>>6}function Ye(e,t,r,o){for(;t<=r;t++){const n=we(e[t]),l=fe(e[t]);if(n>>l)throw new Error("Invalid table entry");if(l>P){const s=o[n>>l-P];if(s.len)throw new Error("Invalid table entry");if(s.lit++,s.p){const c=s.p;s.p=new Array(s.lit);for(let a=0;a<s.lit-1;++a)s.p[a]=c[a]}else s.p=new Array(1);s.p[s.lit-1]=t}else if(l){let s=0;for(let c=1<<P-l;c>0;c--){const a=o[(n<<P-l)+s];if(a.len||a.p)throw new Error("Invalid table entry");a.len=l,a.lit=t,s++}}}return!0}function He(e,t,r,o,n,l,s,c,a){let i=0,u=0;const w=s,b=Math.trunc(o.value+(n+7)/8);for(;o.value<b;){let f=j(i,u,r,o);for(i=f.c,u=f.lc;u>=P;){const d=i>>u-P&Q,p=t[d];if(p.len){u-=p.len;const h=H(p.lit,l,i,u,r,o,c,a,w);h&&(i=h.c,u=h.lc)}else{if(!p.p)throw new Error("hufDecode issues");let h;for(h=0;h<p.lit;h++){const A=fe(e[p.p[h]]);for(;u<A&&o.value<b;)f=j(i,u,r,o),i=f.c,u=f.lc;if(u>=A&&we(e[p.p[h]])==(i>>u-A&(1<<A)-1)){u-=A;const M=H(p.p[h],l,i,u,r,o,c,a,w);M&&(i=M.c,u=M.lc);break}}if(h==p.lit)throw new Error("HufDecode issues")}}}const g=8-n&7;for(i>>=g,u-=g;u>0;){const f=t[i<<P-u&Q];if(f.len){u-=f.len;const d=H(f.lit,l,i,u,r,o,c,a,w);d&&(i=d.c,u=d.lc)}else throw new Error("HufDecode issues")}return!0}function Ze(e,t,r,o,n,l){const s={value:0},c=r.value,a=m(t,r),i=m(t,r);r.value+=4;const u=m(t,r);if(r.value+=4,a<0||a>=z||i<0||i>=z)throw new Error("Wrong HUF_ENCSIZE");const w=new Array(z),b=new Array(J);We(b);const g=o-(r.value-c);if(Ve(e,r,g,a,i,w),u>8*(o-(r.value-c)))throw new Error("Wrong hufUncompress");Ye(w,a,i,b),He(w,b,e,r,u,i,l,n,s)}function q(e){return e&65535}function re(e){const t=q(e);return t>32767?t-65536:t}function x(e,t){const r=re(e),o=re(t),n=r+(o&1)+(o>>1),l=n,s=n-o;return{a:l,b:s}}function N(e,t){const r=q(e),o=q(t),n=r-(o>>1)&ee;return{a:o+n-Fe&ee,b:n}}function Xe(e,t,r,o,n,l,s){const c=s<16384,a=r>n?n:r;let i=1,u,w;for(;i<=a;)i<<=1;for(i>>=1,u=i,i>>=1;i>=1;){w=0;const b=w+l*(n-u),g=l*i,f=l*u,d=o*i,p=o*u;let h,A,M,_;for(;w<=b;w+=f){let v=w;const V=w+o*(r-u);for(;v<=V;v+=p){const O=v+d,E=v+g,L=E+d;if(c){let y=x(e[v+t],e[E+t]);h=y.a,M=y.b,y=x(e[O+t],e[L+t]),A=y.a,_=y.b,y=x(h,A),e[v+t]=y.a,e[O+t]=y.b,y=x(M,_),e[E+t]=y.a,e[L+t]=y.b}else{let y=N(e[v+t],e[E+t]);h=y.a,M=y.b,y=N(e[O+t],e[L+t]),A=y.a,_=y.b,y=N(h,A),e[v+t]=y.a,e[O+t]=y.b,y=N(M,_),e[E+t]=y.a,e[L+t]=y.b}}if(r&i){const O=v+g;let E;c?E=x(e[v+t],e[O+t]):E=N(e[v+t],e[O+t]),h=E.a,e[O+t]=E.b,e[v+t]=h}}if(n&i){let v=w;const V=w+o*(r-u);for(;v<=V;v+=p){const O=v+d;let E;c?E=x(e[v+t],e[O+t]):E=N(e[v+t],e[O+t]),h=E.a,e[O+t]=E.b,e[v+t]=h}}u=i,i>>=1}return w}function Ge(e,t,r){for(let o=0;o<r;++o)t[o]=e[t[o]]}function $e(e){let t=e.byteLength;const r=new Array;let o=0;const n=new DataView(e);for(;t>0;){const l=n.getInt8(o++);if(l<0){const s=-l;t-=s+1;for(let c=0;c<s;c++)r.push(n.getUint8(o++))}else{const s=l;t-=2;const c=n.getUint8(o++);for(let a=0;a<s+1;a++)r.push(c)}}return r}function he(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function je(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),r=new Uint8Array($e(t)),o=new Uint8Array(r.length);return ce(r),le(r,o),new DataView(o.buffer)}function ne(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),r=fflate.unzlibSync(t),o=new Uint8Array(r.length);return ce(r),le(r,o),new DataView(o.buffer)}function qe(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),r=fflate.unzlibSync(t),o=e.lines*e.channels*e.width,n=e.type==1?new Uint16Array(o):new Uint32Array(o);let l=0,s=0;const c=new Array(4);for(let a=0;a<e.lines;a++)for(let i=0;i<e.channels;i++){let u=0;switch(e.type){case 1:c[0]=l,c[1]=c[0]+e.width,l=c[1]+e.width;for(let w=0;w<e.width;++w){const b=r[c[0]++]<<8|r[c[1]++];u+=b,n[s]=u,s++}break;case 2:c[0]=l,c[1]=c[0]+e.width,c[2]=c[1]+e.width,l=c[2]+e.width;for(let w=0;w<e.width;++w){const b=r[c[0]++]<<24|r[c[1]++]<<16|r[c[2]++]<<8;u+=b,n[s]=u,s++}break}}return new DataView(n.buffer)}function Je(e){const t=e.viewer,r={value:e.offset.value},o=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),n=new Uint8Array(K);let l=0;const s=new Array(e.channels);for(let f=0;f<e.channels;f++)s[f]={},s[f].start=l,s[f].end=s[f].start,s[f].nx=e.width,s[f].ny=e.lines,s[f].size=e.type,l+=s[f].nx*s[f].ny*s[f].size;const c=W(t,r),a=W(t,r);if(a>=K)throw new Error("Wrong PIZ_COMPRESSION BITMAP_SIZE");if(c<=a)for(let f=0;f<a-c+1;f++)n[f+c]=B(t,r);const i=new Uint16Array(D),u=De(n,i),w=m(t,r);Ze(e.array,t,r,w,o,l);for(let f=0;f<e.channels;++f){const d=s[f];for(let p=0;p<s[f].size;++p)Xe(o,d.start+p,d.nx,d.size,d.ny,d.nx*d.size,u)}Ge(i,o,l);let b=0;const g=new Uint8Array(o.buffer.byteLength);for(let f=0;f<e.lines;f++)for(let d=0;d<e.channels;d++){const p=s[d],h=p.nx*p.size,A=new Uint8Array(o.buffer,p.end*R,h*R);g.set(A,b),b+=h*R,p.end+=h}return new DataView(g.buffer)}var U;(function(e){e[e.Float=0]="Float",e[e.HalfFloat=1]="HalfFloat"})(U||(U={}));class k{}k.DefaultOutputType=U.HalfFloat;k.FFLATEUrl="https://unpkg.com/fflate@0.8.2";async function Ke(e,t,r,o){const n={size:0,viewer:t,array:new Uint8Array(t.buffer),offset:r,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,channelLineOffsets:{},scanOrder:()=>0,bytesPerLine:0,outLineWidth:0,lines:0,scanlineBlockSize:0,inputSize:null,type:0,uncompress:null,getter:()=>0,format:5,outputChannels:0,decodeChannels:{},blockCount:null,byteArray:null,linearSpace:!1,textureType:0};switch(e.compression){case C.NO_COMPRESSION:n.lines=1,n.uncompress=he;break;case C.RLE_COMPRESSION:n.lines=1,n.uncompress=je;break;case C.ZIPS_COMPRESSION:n.lines=1,n.uncompress=ne,await Y.LoadScriptAsync(k.FFLATEUrl);break;case C.ZIP_COMPRESSION:n.lines=16,n.uncompress=ne,await Y.LoadScriptAsync(k.FFLATEUrl);break;case C.PIZ_COMPRESSION:n.lines=32,n.uncompress=Je;break;case C.PXR24_COMPRESSION:n.lines=16,n.uncompress=qe,await Y.LoadScriptAsync(k.FFLATEUrl);break;default:throw new Error(C[e.compression]+" is unsupported")}n.scanlineBlockSize=n.lines;const l={};for(const i of e.channels)switch(i.name){case"Y":case"R":case"G":case"B":case"A":l[i.name]=!0,n.type=i.pixelType}let s=!1;if(l.R&&l.G&&l.B)s=!l.A,n.outputChannels=4,n.decodeChannels={R:0,G:1,B:2,A:3};else if(l.Y)n.outputChannels=1,n.decodeChannels={Y:0};else throw new Error("EXRLoader.parse: file contains unsupported data channels.");if(n.type===1)switch(o){case U.Float:n.getter=ge,n.inputSize=R;break;case U.HalfFloat:n.getter=W,n.inputSize=R;break}else if(n.type===2)switch(o){case U.Float:n.getter=S,n.inputSize=Z;break;case U.HalfFloat:n.getter=Ie,n.inputSize=Z}else throw new Error("Unsupported pixelType "+n.type+" for "+e.compression);n.blockCount=n.height/n.scanlineBlockSize;for(let i=0;i<n.blockCount;i++)Ee(t,r);const c=n.width*n.height*n.outputChannels;switch(o){case U.Float:n.byteArray=new Float32Array(c),n.textureType=1,s&&n.byteArray.fill(1,0,c);break;case U.HalfFloat:n.byteArray=new Uint16Array(c),n.textureType=2,s&&n.byteArray.fill(15360,0,c);break;default:throw new Error("Unsupported type: "+o)}let a=0;for(const i of e.channels)n.decodeChannels[i.name]!==void 0&&(n.channelLineOffsets[i.name]=a*n.width),a+=i.pixelType*2;return n.bytesPerLine=n.width*a,n.outLineWidth=n.width*n.outputChannels,e.lineOrder==="INCREASING_Y"?n.scanOrder=i=>i:n.scanOrder=i=>n.height-1-i,n.outputChannels==4?(n.format=5,n.linearSpace=!0):(n.format=6,n.linearSpace=!1),n}function Qe(e,t,r,o){const n={value:0};for(let l=0;l<e.height/e.scanlineBlockSize;l++){const s=I(r,o)-t.dataWindow.yMin;e.size=m(r,o),e.lines=s+e.scanlineBlockSize>e.height?e.height-s:e.scanlineBlockSize;const c=e.size<e.lines*e.bytesPerLine&&e.uncompress?e.uncompress(e):he(e);o.value+=e.size;for(let a=0;a<e.scanlineBlockSize;a++){const i=l*e.scanlineBlockSize,u=a+e.scanOrder(i);if(u>=e.height)continue;const w=a*e.bytesPerLine,b=(e.height-1-u)*e.outLineWidth;for(let g=0;g<e.channels;g++){const f=t.channels[g].name,d=e.channelLineOffsets[f],p=e.decodeChannels[f];if(p!==void 0){n.value=w+d;for(let h=0;h<e.width;h++){const A=b+h*e.outputChannels+p;e.byteArray&&(e.byteArray[A]=e.getter(c,n))}}}}}}class tt{constructor(){this.supportCascades=!1}loadCubeData(t,r,o,n,l){throw".exr not supported in Cube."}async loadData(t,r,o){const n=new DataView(t.buffer),l={value:0},s=Le(n,l),c=await Ke(s,n,l,k.DefaultOutputType);Qe(c,s,n,l);const a=s.dataWindow.xMax-s.dataWindow.xMin+1,i=s.dataWindow.yMax-s.dataWindow.yMin+1;o(a,i,r.generateMipMaps,!1,()=>{const u=r.getEngine();r.format=s.format,r.type=c.textureType,r.invertY=!1,r._gammaSpace=!s.linearSpace,c.byteArray&&u._uploadDataToTextureDirectly(r,c.byteArray,0,0,void 0,!0)})}}export{tt as _ExrTextureLoader};
